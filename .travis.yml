language: node_js
node_js: 10
dist: xenial
cache:
  yarn: true
  directories:
    - node_modules

# Set some immportant things to help maximize our CI performance
before_install:
  # Get list of files that have changed
  - export LANDO_CHANGED_FILES=$(git diff --name-only $TRAVIS_COMMIT_RANGE | cat)
  # Assess whether our web props have changed
  - export LANDO_API_CHANGED=$(echo $LANDO_CHANGED_FILES | grep -e api/ &>/dev/null && echo true || echo false)
  - export LANDO_BLOG_CHANGED=$(echo $LANDO_CHANGED_FILES | grep -e blog/ &>/dev/null && echo true || echo false)
  - export LANDO_DOCS_CHANGED=$(echo $LANDO_CHANGED_FILES | grep -e docs/ &>/dev/null && echo true || echo false)
  - export LANDO_EVENTS_CHANGED=$(echo $LANDO_CHANGED_FILES | grep -e events/ &>/dev/null && echo true || echo false)
  - export LANDO_METRICS_CHANGED=$(echo $LANDO_CHANGED_FILES | grep -e metrics/ &>/dev/null && echo true || echo false)
  - export LANDO_SITE_CHANGED=$(echo $LANDO_CHANGED_FILES | grep -e website/ &>/dev/null && echo true || echo false)
  # Assess what parts of lando have changed
  - export LANDO_CODE_CHANGED=$(echo $LANDO_CHANGED_FILES | grep -e yarn.lock -e package.json -e config.yml -e bin/ -e lib/ -e plugins/ &>/dev/null && echo true || echo false)
  - export LANDO_TESTS_CHANGED=$(echo $LANDO_CHANGED_FILES | grep -e examples/ -e test/ &>/dev/null && echo true || echo false)
  # Assess devops changes
  - export LANDO_BUILD_CHANGED=$(echo $LANDO_CHANGED_FILES | grep -e .travis.yml -e /scripts &>/dev/null && echo true || echo false)
  - export LANDO_INSTALLER_CHANGED=$(echo $LANDO_CHANGED_FILES | grep -e /installer -e /scripts &>/dev/null && echo true || echo false)
  # Check the status of the important things
  - env | grep LANDO_
  - ./scripts/travis-env.sh

# Run some sanity checks
before_script:
  - node --version
  - yarn --version
install: yarn

jobs:
  include:
    # Preflight
    - stage: preflight
      name: Code Linter
      script:
        - yarn lint
        - yarn lint:sites

    # Test
    - stage: test
      name: Unit Tests - Linux
      before_script: node bin/lando.js version
      script: yarn test:unit
      if: type = pull_request
    - name: Unit Tests - macOS
      os: osx
      osx_image: xcode11.2
      before_script: node bin/lando.js version
      script: yarn test:unit
      if: type = pull_request
    - name: Unit Tests - Windoze
      os: windows
      before_script: node bin/lando.js version
      script: yarn test:unit
      env: YARN_GPG=no GRADLE_OPTS=-Dorg.gradle.daemon=false
      if: type = pull_request

    # Build
    # MacOS builds
    - stage: Build
      name: CLI Binary - macOS
      os: osx
      osx_image: xcode11.2
      script: |
        if [[ "$LANDO_CODE_CHANGED" == "true" ]] ; then
          yarn pkg:cli
          ./dist/cli/lando-* version
        fi
      if: type = push
    - name: Installer - DMG
      os: osx
      osx_image: xcode11.2
      env: LANDO_PKG_TYPE=dmg APPLE_NO_NOTARIZE=notgonnadoit
      before_script: ./scripts/import-apple-keys.sh
      script: |
        if [[ "$LANDO_INSTALLER_CHANGED" == "true" ]] ; then
          mkdir release
          yarn pkg:full
        fi
      if: type = push

    # Windoze builds
    - name: CLI Binary - Windoze
      os: windows
      env: YARN_GPG=no GRADLE_OPTS=-Dorg.gradle.daemon=false
      script: |
        if [[ "$LANDO_CODE_CHANGED" == "true" ]] ; then
          yarn pkg:cli
          ./dist/cli/lando-* version
        fi
      if: type = push
    - name: Installer - EXE
      os: windows
      env: YARN_GPG=no GRADLE_OPTS=-Dorg.gradle.daemon=false LANDO_PKG_TYPE=exe
      before_script:
        - git config --global core.autocrlf true
        - choco install innosetup --version=5.5.9 --allow-empty-checksums
      script: |
        if [[ "$LANDO_INSTALLER_CHANGED" == "true" ]] ; then
          mkdir release
          yarn pkg:full
        fi
      if: type = push

    # Linux builds
    - name: CLI Binary - Linux
      script: |
        if [[ "$LANDO_CODE_CHANGED" == "true" ]] ; then
          yarn pkg:cli
          ./dist/cli/lando-* version
        fi
      if: type = push
    - name: Installer - PACMAN
      env: LANDO_PKG_TYPE=pacman
      script: |
        if [[ "$LANDO_INSTALLER_CHANGED" == "true" ]] ; then
          mkdir release
          yarn pkg:full
        fi
      if: type = push
    - name: Installer - RPM
      env: LANDO_PKG_TYPE=rpm
      script: |
        if [[ "$LANDO_INSTALLER_CHANGED" == "true" ]] ; then
          mkdir release
          yarn pkg:full
        fi
      if: type = push
    - name: Installer - DEB
      env: LANDO_PKG_TYPE=deb
      script: |
        if [[ "$LANDO_INSTALLER_CHANGED" == "true" ]] ; then
          mkdir release
          yarn pkg:full
        fi
      if: type = push

    # Web builds
    - name: API
      script: if [[ "$LANDO_API_CHANGED" == "true" ]] ; then true; fi
      if: type = push
    - name: Blog
      script: if [[ "$LANDO_BLOG_CHANGED" == "true" ]] ; then yarn build:blog; fi
      if: type = push
    - name: Documentation
      script: if [[ "$LANDO_DOCS_CHANGED" == "true" ]] ; then yarn build:docs; fi
      if: type = push
    - name: Events
      script: if [[ "$LANDO_EVENTS_CHANGED" == "true" ]] ; then yarn build:events; fi
      if: type = push
    - name: Metrics
      script: if [[ "$LANDO_METRICS_CHANGED" == "true" ]] ; then true; fi
      if: type = push
    - name: Website
      script: if [[ "$LANDO_SITE_CHANGED" == "true" ]] ; then yarn build:site; fi
      if: type = push

    # Test Deployz
    - stage: Deploy
      name: Test Deploy - S3
      install: skip
      script: mkdir release && touch release/test
      if: type = pull_request
      deploy:
        provider: s3
        access_key_id: AKIAJXCGUYNMSXQPAKYQ
        secret_access_key:
          secure: HstC04mBeuucF2PseyrNLXGZlt5WQ23iwWRrkh4rWTuqq2F4tKkTc+pCB6+Kx64ZE3OGx5T2KdyPOPhLYJOPmYhtTtE0RFI4oF2kEUxvLjTRLrXqDNHKL47PZ5Vel4Z/MTTfWka0M7wCxslBsbomPhO3ljUxlcqChqsh+VT+3JEFYJw4JmEbWHGQ/GnIdTkAksvMfiOFbZHGK+14NjKic9BOwqeBiItSLcydAzURKZOUmcp+u5dNGhHuM+fb98zenhxFIMp75ErwiENv5ER1ja42C+Hyveu3wWc/QIlZHarMULRlH+Zq3yDUCOeOoFjIgeb+H7MGVots8igGIZ4h17/eU8lAO6uRYLLKup/T87CH82VjMDYEDbwsr3XM6f20q/5Fk2dr1XLo+xwhFadIlpJgsbPpmGHu+QuuYczlqdGzw3Qn1IAzU9L7aitjmNQ1ReSGySjlD8sN0nNT7OJYW/4cdy9+RcoYpH4+dbNzjq9DXubJe1EeYQagd/7ebnHvazg5/5Av2whn/F5YjObwno+JrEDzgD2H0pOWfEVBjGT1uOaDIO7Itn1KTJl+gV9Uv+QJ0G/1wP3fnL3KOzMqqFATubtgBUqe12VQ39jUALmgfBKEdXMF2tojwtHkP4b+vQUszpkGxpNih4JmyJYEgc0CZTSNxQP0m+j+3HH/jDc=
        bucket: files.devwithlando.io
        local-dir: release
        acl: public_read
        region: us-west-2
        skip_cleanup: true

    # Dev deployz
    - name: Dev Deploy - PACMAN
      env: LANDO_PKG_TYPE=pacman
      script: |
        mkdir release
        node ./scripts/dev-version.js
        yarn pkg:full
        cp -rf dist/lando.$LANDO_PKG_TYPE release/lando-latest-dev.$LANDO_PKG_TYPE
        cp -rf dist/lando.$LANDO_PKG_TYPE release/lando-$TRAVIS_COMMIT-dev.$LANDO_PKG_TYPE
      if: |
        type = push AND \
        tag IS blank AND \
        branch != "master"
      deploy:
        provider: s3
        access_key_id: AKIAJXCGUYNMSXQPAKYQ
        secret_access_key:
          secure: HstC04mBeuucF2PseyrNLXGZlt5WQ23iwWRrkh4rWTuqq2F4tKkTc+pCB6+Kx64ZE3OGx5T2KdyPOPhLYJOPmYhtTtE0RFI4oF2kEUxvLjTRLrXqDNHKL47PZ5Vel4Z/MTTfWka0M7wCxslBsbomPhO3ljUxlcqChqsh+VT+3JEFYJw4JmEbWHGQ/GnIdTkAksvMfiOFbZHGK+14NjKic9BOwqeBiItSLcydAzURKZOUmcp+u5dNGhHuM+fb98zenhxFIMp75ErwiENv5ER1ja42C+Hyveu3wWc/QIlZHarMULRlH+Zq3yDUCOeOoFjIgeb+H7MGVots8igGIZ4h17/eU8lAO6uRYLLKup/T87CH82VjMDYEDbwsr3XM6f20q/5Fk2dr1XLo+xwhFadIlpJgsbPpmGHu+QuuYczlqdGzw3Qn1IAzU9L7aitjmNQ1ReSGySjlD8sN0nNT7OJYW/4cdy9+RcoYpH4+dbNzjq9DXubJe1EeYQagd/7ebnHvazg5/5Av2whn/F5YjObwno+JrEDzgD2H0pOWfEVBjGT1uOaDIO7Itn1KTJl+gV9Uv+QJ0G/1wP3fnL3KOzMqqFATubtgBUqe12VQ39jUALmgfBKEdXMF2tojwtHkP4b+vQUszpkGxpNih4JmyJYEgc0CZTSNxQP0m+j+3HH/jDc=
        bucket: files.devwithlando.io
        local-dir: release
        acl: public_read
        region: us-west-2
        skip_cleanup: true

    # Prod deployz
    - name: Deploy - PACMAN
      env: LANDO_PKG_TYPE=pacman
      script: |
        mkdir release
        yarn pkg:full
        cp -rf dist/lando.$LANDO_PKG_TYPE release/lando-$TRAVIS_TAG.$LANDO_PKG_TYPE
        cp -rf dist/lando.$LANDO_PKG_TYPE release/lando-stable.$LANDO_PKG_TYPE; fi
      if: |
        type = push AND \
        tag IS NOT blank AND \
        branch = "master"
      deploy:
        provider: releases
        api_key:
          secure: UXDea6KLTOOiUaUfhYqE7stUY74VE2gOdi3No5NscD0Lg3xB/EMf1wzpVe2nuTpjn1CbDBsGXXHqRRpy2IZj6qp21D39+Wygznv9PpSGPgTAB2ZHRYhpux1Qf/HxD8R/NhvISNMXukNLyd66OyiJlz5RWoLWQvLIiJgT1Uczc3Sj8iOJOmYaxQZku/3/q/LmjKKHVJ9vq7ail4l4SoNmLqh6sdDt9utJtavWHMa0hN5kF+CwoV5Vk/z2RFzYNInGwlJggwV7Y/Kf3TmOQv0CiKgxdEQqR8LfTDGIvkxFwpPSf7JnQYnsZWcOWW08oousN7tjc1L1ow2dzPnT2zRYNyx73FwkjWtZ7SLQCkU95pq6FgSy31+w6iWU6Rvwd9mgdX4sfxgdwxLwiF38Rki5TxXtMRGWW1qYRYvnCcc7gpPUPFv0PzsQYZiFSGxMF3uKdKxmKzYd+tfCMvE5YhfkDtCM+LeJBlSL5hZspMUezXEFtiKSv7fDmBKtGGFUsEruNqMphKEbH1kY1UT9SXUu+uxWN40ciJTXfQXJAGMSh34WkZFAgEP/r61+SZDlpuyYPQ8l8fOOcX2uaJYD0LJBSERVmVAX00SNxWSVdTTGibadRXWWuJ4gd4PGCXUhSJI9r1QLfMLyZtt5P3i9SUL2X4cO9isKysBjOq/5DZXjqq0=
        file: release/lando-$TRAVIS_TAG.$LANDO_PKG_TYPE
        skip_cleanup: true

      # Edit the package.json if this isn't an official release
      # - if [ -z "$TRAVIS_TAG" ]; then node ./scripts/dev-version.js; fi
      # Do some sanity checks

stages:
  - preflight
  - test
  - build
  - deploy
