language: node_js
node_js: 10
dist: xenial
cache:
  yarn: true
  directories:
    - node_modules
env:
  - YARN_GPG=no
  - GRADLE_OPTS=-Dorg.gradle.daemon=false

# Set some immportant things to help maximize our CI performance
before_install:
  # Get list of files that have changed
  - export LANDO_CHANGED_FILES=$(git diff --name-only $TRAVIS_COMMIT_RANGE | cat)
  # Assess whether our web props have changed
  - export LANDO_API_CHANGED=$(echo $LANDO_CHANGED_FILES | grep -e api/ &>/dev/null && echo true || echo false)
  - export LANDO_BLOG_CHANGED=$(echo $LANDO_CHANGED_FILES | grep -e blog/ &>/dev/null && echo true || echo false)
  - export LANDO_DOCS_CHANGED=$(echo $LANDO_CHANGED_FILES | grep -e docs/ &>/dev/null && echo true || echo false)
  - export LANDO_EVENTS_CHANGED=$(echo $LANDO_CHANGED_FILES | grep -e events/ &>/dev/null && echo true || echo false)
  - export LANDO_METRICS_CHANGED=$(echo $LANDO_CHANGED_FILES | grep -e metrics/ &>/dev/null && echo true || echo false)
  - export LANDO_SITE_CHANGED=$(echo $LANDO_CHANGED_FILES | grep -e website/ &>/dev/null && echo true || echo false)
  # Assess what parts of lando have changed
  - export LANDO_CODE_CHANGED=$(echo $LANDO_CHANGED_FILES | grep -e bin/ -e lib/ -e plugins/ &>/dev/null && echo true || echo false)
  - export LANDO_TESTS_CHANGED=$(echo $LANDO_CHANGED_FILES | grep -e examples/ -e test/ &>/dev/null && echo true || echo false)
  - export LANDO_BUILD_CHANGED=$(echo $LANDO_CHANGED_FILES | grep -e .travis.yml -e /scripts &>/dev/null && echo true || echo false)
  - export LANDO_INSTALLER_CHANGED=$(echo $LANDO_CHANGED_FILES | grep -e /installer -e /scripts &>/dev/null && echo true || echo false)
  # Assess build/devops changes
  - export LANDO_BUILD_CHANGED=$(echo $LANDO_CHANGED_FILES | grep -e .travis.yml -e scripts/ &>/dev/null && echo true || echo false)

  # Check the status of the important things
  - env | grep LANDO_
  - ./scripts/travis-env.sh

# Run some sanity checks
before_script:
  # Edit the package.json if this isn't an official release
  - if [ -z "$TRAVIS_TAG" ]; then node ./scripts/dev-version.js; fi
  # Do some sanity checks
  - node --version
  - yarn --version
  - node bin/lando.js version
install: yarn

jobs:
  include:
    # Sanity checks
    - stage: preflight
      name: Code Linter
      os: linux
      dist: xenial
      script:
        - yarn lint
        - yarn lint:sites

    # Test
    - stage: test
      name: Unit Tests - Linux
      os: linux
      dist: xenial
      script: yarn test
    - name: Unit Tests - macOS
      os: osx
      osx_image: xcode11.2
      script: yarn test
    - name: Unit Tests - Windoze
      os: windows
      script: yarn test

    # Build
    - stage: Build
      name: API
      script: if [[ "$LANDO_API_CHANGED" == "true" ]] ; then true test; fi
    - name: Blog
      script: if [[ "$LANDO_BLOG_CHANGED" == "true" ]] ; then yarn build:blog test; fi
    - name: Documentation
      script: if [[ "$LANDO_DOCS_CHANGED" == "true" ]] ; then yarn build:docs test; fi
    - name: Events
      script: if [[ "$LANDO_EVENTS_CHANGED" == "true" ]] ; then yarn build:events test; fi
    - name: Metrics
      script: if [[ "$LANDO_METRICS_CHANGED" == "true" ]] ; then true test; fi
    - name: Website
      script: if [[ "$LANDO_SITE_CHANGED" == "true" ]] ; then yarn build:site test; fi
    - name: CLI Binary - Linux
      script:
        - yarn pkg:cli
        - ./dist/cli/lando-* version
    - name: CLI Binary - macOS
      os: osx
      osx_image: xcode11.2
      script:
        - yarn pkg:cli
        - ./dist/cli/lando-* version
    # - name: CLI Binary - Windoze
    # os: windows
    # script: yarn pkg:cli

    # Deploy
    - stage: deploy
      name: "Deploy to GCP"
      script: |
        ./scripts/travis-env.sh
        node -v
      if: env(LANDO) IS present

stages:
  - preflight
  - test
  - build
  - deploy
